---
title: 堆
author: Noah
date: 2024/07/04 16:32
categories: 
 - JVM
tags:
 - Java
 - JVM
 - JDK
---

# 堆

[[toc]]

在Java中，堆(Heap)是JVM内存模型中的一个重要区域，用于存储所有对象的实力和数组。堆是Java应用程序中最大的一块内存区域，由所有线程共享，负责动态分配内存。

## 特点

1. **线程共享:** 堆内存是所有线程共享的，任何线程都可以访问堆中的对象。
2. **动态分配:** 堆内存用于动态分配对象的内存空间，对象的生命周期由垃圾收集器管理。
3. **自动内存管理:** JVM通过垃圾收集器自动管理堆内存分配和回收，无需程序员手动干预。

## 结构

Java堆通常分为三个主要区域：新生代(Young Generation)、老年代(Old Generation) 和永久代/元空间(Permanent Generation / Metaspace)。

::: warning 注意💡

在JDK1.6之前，一直采用的永久代，之后在JDK1.7中有一个理念叫做"去永久代"。在JDK1.7中，永久代慢慢退化，直到JDK1.8之后的版本，彻底将永久代替换为元空间。

:::

1. **新生代(Young Generation)**
   新生代用于存储新创建的对象，大部分对象在新生代中创建并很快被垃圾收集器回收。新生代分为三个区域:

   - **伊甸区(Eden):** 新对象在Eden区分配内存。
   - **两个幸存区(Survivor0和Survivor1):** 用于在Minor GC(年轻代垃圾回收)时存活对象的复制。

   在Eden区和两个Survivor区之间进行对象的复制和移动，以便于在Minor GC时回收内存。

2. **老年代(Old Generation):**
   老年代用于存储生命周期较长的对象。经过多次Minor GC 仍然存活的对象会从新生代晋升到老年代。当老年代内存不足时，触发 Major GC(老年代垃圾回收)，这通常是耗时较长的一次回收。

3. **永久代/元空间(Permanent Generation / Metaspace):** 
   永久代(在Java 8之前)或元空间(从Java 8 开始) 用于存储类的元数据、方法信息、常量池和JIT编译后的代码。

   - **永久代(PernGen):** 存储类信息、常量、静态变量等。
   - **元空间(Meataspace):** 从Java 8开始，取代永久代，使用本地内存存储类的元数据。

![](https://raw.githubusercontent.com/Noah2Y/img/main/blog/20240704182701.jpg)

## 垃圾收集(Garbage Collection)

堆内存由垃圾收集器管理，垃圾收集器负责回收不再使用的对象，释放内存。垃圾收集器主要分为两类：

- **Minor GC:** 回收新生代内存，频率较高，但速度较快。
- **Major GC:** 回收新生代内存，频率较低，但耗时较长，通常是 Minor GC 的10倍以上。

::: warning 注意💡

值得注意的是 在JVM中还有一个叫做Full GC的垃圾回收器，它的作用范围是整个堆内存。

:::

| 特效     | Minor GC               | Major GC                           | Full GC                           |
| -------- | ---------------------- | ---------------------------------- | --------------------------------- |
| 目标区域 | 主要回收新生代         | 主要回收老年代                     | 回收整个堆内存                    |
| 触发条件 | 新生代内存不足         | 老年代内存不足                     | 内存紧张，老年代空间不足          |
| 执行频率 | 较高                   | 较低                               | 较低                              |
| 性能影响 | 耗时最短的GC，频率最高 | 比 Minor GC 耗时长，但低于 Full GC | 最耗时，暂停所有应用线程          |
| 影响范围 | 主要针对新生代         | 主要针对老年代                     | 涉及新生代、老年代和永久代/元空间 |

## 堆内存管理参数

在 Java 中，可以通过以下 JVM 参数来配置堆内存的大小和管理策略：

- **`-Xms`:** 设置堆内存初始大小。
- **`-Xmx`:** 设置堆内存最大大小。
- **`-XX:NewRation`:** 设置新生代和老年代的比率。
- **`-XX:SurvivorRation`:** 设置 Eden 区和 Survivor 区的比率。
- **`-XX:MetaspaceSize`:** 设置元空间的初始大小(从 Java 8 开始)。
- **`-XX:MaxMetaspaceSize`:** 设置元空间的最大大小(从 Java 8 开始)。
