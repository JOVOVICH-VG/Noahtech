---
title: Redis持久化之RDB
author: Noah
date: 2024/07/07 19:31
categories: 
 - Redis进阶
tags:
 - Redis
 - Redis进阶
---
# Redis持久化之RDB
[[toc]]

::: tip 前言

RDB（Redis Database Backup）持久化是将某个时间点的数据快照保存到磁盘文件中，下面将介绍RDB的工作原理、选项配置、优缺点以及如何使用RDB持久化来确保数据安全性和一致性。

:::

## 什么是 RDB 持久化

RDB 持久化是指 Redis将内存中的数据快照保存到磁盘上，以便在Redis重启时可以恢复数据。RDB文件通常以  `.rdb` 为扩展名，默认文件是 `dump.rdb` 。RDB 持久化可以手动触发，也可以通过自动触发来定期生成快照。

## RDB 的工作原理

RDB 持久化主要有两种生成快照的方式: **手动触发** 和 **自动触发**

### 手动触发

在Redis提供的命令中有以下两种方式可以手动生成快照

- **SAVE:** 立即生成RDB快照。该命令会阻塞 Redis 服务器，直到快照生成完成。
- **BGSAVE:** 在后台异步生成 RDB快照。该命令不会阻塞 Redis 服务器线程。

### 自动触发

```bash
# 在900秒内，如果至少有1个键被修改，就触发RDB快照
save 900 1

# 在300秒内，如果至少有10个键被修改，就触发RDB快照
save 300 10

# 在60秒内，如果至少有10000个键被修改，就触发RDB快照
save 60 10000
```

只要满足了以上配置中任意一个条件，Redis 就会触发 BGSAVE 命令来生成 RDB 快照。

### 配置 RDB 持久化

可以通过 `redis.conf` 配置文件来调整 RDB 持久化的设置

```bash
# 配置自动触发条件
save 900 1
save 300 10
save 60 10000

# RDB 文件名
dbfilename dump.rdb

# RDB 文件保存路径
dir /var/lib/redis

# 在创建新的RDB文件前，是否进行压缩。设置为yes表示压缩，以减少磁盘空间的占用。
rdbcompression yes

# 是否在创建RDB文件时校验文件。默认是yes，表示RDB文件会包含数据校验和（CRC64）。
rdbchecksum yes

```

在 Redis 启动的时候，如果发现配置文件中定义了 RDB 文件且该文件存在， Redis 将自动加载 RDB 文件来恢复数据。这使得 Redis 能够在重启后恢复到最新的快照。

## RDB 的 持久化过程

1. RDB 会单独创建(fork)一个子进程来进行持久化。
2. 先将内存的内容写入到一个临时的文件中。
3. 等持久化过程都结束了，再用这个临时文件替换上次持久化的快照文件。

::: warning 注意:dagger:

主进程不进行任何IO操作，这确保了极高的性能。如果需要进行大规模的数据恢复，且对于数据恢复的完整性不是非常敏感，那 RDB要不AOF方式更加的高效。

:::

![](https://raw.githubusercontent.com/Noah2Y/img/main/blog/20240708133058.jpg)

## 优缺点

### 优点

- **高效的启动时间:** 由于 RDB 文件是一个紧凑的二进制文件，Redis在启动时加载 RDB 文件相对较快。
- **备份灵活:** RDB 文件是独立的快照，可以很方便的将其复制、移动到其他的存储设备或云存储服务进行数据备份。
- **性能高效:** 生成 RDB 快照是后台异步操作，不会显著影响 Redis 的性能，适合需要高吞吐量的数据写入场景。

### 缺点

- **数据丢失风险:** 由于 RDB 快照是根据时间间隔生成的，如果在生成间隔期间 Redis 崩溃或重启，最后一次快照后的所有数据变更将会丢失。
- **实时性能不足:** RDB 快照生成的频率取决于配置，不适合需要实时数据持久化的场景。





