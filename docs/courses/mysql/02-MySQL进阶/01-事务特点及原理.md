---
title: 事务特点及原理
author: Noah
date: 2024/06/28 20:22
categories: 
 - MySQL进阶
tags:
 - MySQL
 - 事务
 - 并发事务
---
# 事务特点及原理

[[toc]]

::: tip 前言

本章涉及到的 `MySQL` 日志系统会在后续单独开一篇文章介绍。

:::

## 什么是事务？

数据库中的事务是指对数据库执行一系列操作，在同一个事务中，这些操作最终要么全部执行成功，要么全部执行失败，不存在部分成功的情况。

::: info 举个栗子:

张飞需要给刘备转账1000元，过程如下：

- 从张飞账户上扣款1000
- 给刘备账户上增加1000

如果在事务的支持下，上面最终只会有两种结果

- 操作成功，张飞账户上减少1000，刘备账户上增加1000。
- 操作失败，刘备张飞双方账户没有变化。

:::

## 事务的四个特性(ACID)

### 原子性 (Atomicity)

事务的整个过程如原子操作一样，要么全部成功，要么全部失败。

实现原理：`undo log` 

### 一致性(Consistency)

一个事务必须让数据库从一个一致性的状态变换到另一个一致性的状态。例如张飞像刘备转账，张飞的账户的钱少了，而刘备账户的钱却没有增加，那么我们认为此时的数据处于不一致的状态。

实现原理：一致性是我们的根本追求，依托于其他三个特性

### 隔离性

一个事务的执行，不能被其他事务干扰。一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能相互干扰。

实现原理：多版本井发控制，即 `MVCC` ，和锁

#### 隔离级别

- `read uncommitted` ：读未提交，允许读未提交的数据，即脏读。
- `read committed` : 读已提交，只能读已提交的数据，防止脏读。
- `repeatable read` : 可重复读，确保在同一个事务中多次读取同样的数据结果是一样的，防止不可重复度(默认隔离级别)。
- `serializable` : 串行化，最高隔离级别，完全隔离，事务必须安顺序执行，防止幻读

### 持久性

事务一旦提交，对数据库中的数据改变是永久性的。当事务提交之后，数据会持久化存储在硬盘，就算是断电或者其他原因也不能影响结果。

实现原理：`redo log`

## 并发事务产生的问题

### 更新丢失

丢失更新是两个不同的事务(或 `Java` 程序线程) 在某一时刻对同一数据进行读取后，先后进行修改，导致第一次操作数据丢失。

::: warning **注意**💡

第一类: A, B 事务同时操作同一数据，A 先对数据进行了更改，B 再次更改时失败然后回滚，把A更新的数据连带回滚。(事务撤销造成的撤销丢失)。

第二类：A，B 事务同时操作同一数据，A先对改数据进行了更改，B再次更改并且提交，把A提交的数据给覆盖了。(事务提交造成的覆盖丢失)。

:::

### 脏读

一个事务在执行的过程中读取到了其他事务还没有提交的数据。

::: warning **注意**💡

A，B 两个事务并发且操作同一数据，A事务对数据进行了修改还没提交，B事务访问并使用了这条数据，此时A事务回滚，那么B事务读到的数据就是脏数据。B事务读到的数据还是回滚前的数据。

:::

### 读已提交

一个事务操作过程中可以读取到其他事务已经提交的数据。事务每次读取操作，读到的都是数据库中其他事务已经提交的的最新数据。

### 不可重复读

同一事务中，多次读取同一数据返回的结果有所不同。换句话说，后续读取可以读到另一事务已经提交的**更新数据**。

### 可重复读

“可重复读”在同一事务中多次读到数据时，能保证所读数据一样，也就是后续读取不能读取另一事务已经提交的**更新数据**。

### 幻读

幻读是指一个事务中，多次读取同一个查询条件的数据集合时，由于其他事务插入或删除了数据，导致两次读取数据集合不一样。这种现象在并发环境下容易出现，特别是在隔离级别低的情况下。

::: info 举个栗子

假如现在有一个数据库 `employess` ，记录了所有员工的信息：

```mysql
CREATE TABLE employess (
	id INT PRIMARY KEY,
	name VARCHAR(100),
    salary DECIMAL(10,2)
);
```

假设当前表中的数据如下：

| id   | name | salary |
| ---- | ---- | :----- |
| 1    | 张飞 | 5000   |
| 2    | 刘备 | 6000   |

假设有两个事务，A 和 B

- 事务 A ：
  1. 开始事务
  2. 查询工资大于4000的员工
  3. 等待一段时间
  4. 再次查询工资大于4000的员工
  5. 提交事务
- 事务 B :
  1. 开始事务
  2. 插入一条工资为5500的员工信息，这里取名为关羽
  3. 提交事务

在事务A 的第一次查询中，结果是**张飞**,、**刘备**。在事务B插入了一条新纪录之后，事务A的第二次查询中，结果多了一条**关羽**的记录。这里事务A在查询时看到了事务B在期间插入的新数据，这就是幻读。

:::
